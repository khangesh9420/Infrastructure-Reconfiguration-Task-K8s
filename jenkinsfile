pipeline {
  agent { label 'k8s-agent' }
  environment {
    REGISTRY = "khangeshmatte123"
    BUILD_ID = "${env.BUILD_ID}"
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Login to Docker Hub (Buildah)') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh 'buildah login -u $DOCKER_USER -p $DOCKER_PASS docker.io'
        }
      }
    }

    stage('Build Images with Buildah') {
      steps {
        sh '''
          buildah bud -t docker.io/$REGISTRY/book-service:$BUILD_ID book-service
          buildah bud -t docker.io/$REGISTRY/user-service:$BUILD_ID user-service
        '''
      }
    }

    stage('Push Images with Buildah') {
      steps {
        sh '''
          buildah push docker.io/$REGISTRY/book-service:$BUILD_ID
          buildah push docker.io/$REGISTRY/user-service:$BUILD_ID
        '''
      }
    }

    stage('Update Manifests & Push to Git') {
      environment {
        GIT_REPO_NAME = "Infrastructure-Reconfiguration-Task-K8s"
        GIT_USER_NAME = "khangesh9420"
      }
      steps {
        withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
          sh '''
            chmod +x update-images.sh
            ./update-images.sh

            git config --global user.name "khangesh9420"
            git config --global user.email "khangeshmatte@gmail.com"

            # Determine current branch or fallback
            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            if [ "$CURRENT_BRANCH" = "HEAD" ] || [ -z "$CURRENT_BRANCH" ]; then
              CURRENT_BRANCH="main"
              git checkout $CURRENT_BRANCH
            fi

            echo "On branch: $CURRENT_BRANCH"

            git add k8s_manifest/book-service.yaml k8s_manifest/user-service.yaml

            if ! git diff --cached --quiet; then
              git commit -m "ci: update image tags to $BUILD_ID"
              git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git $CURRENT_BRANCH
            else
              echo "No changes to commit"
            fi
          '''
        }
      }
    }
  }
}
