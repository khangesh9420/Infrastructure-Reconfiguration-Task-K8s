pipeline {
  agent { label 'k8s-agent' }

  environment {
    REGISTRY = "khangeshmatte123"
    BUILD_ID = "${env.BUILD_ID}"
    SONAR_HOST_URL = 'http://108.142.232.37:9000'
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Login to Docker Hub (Buildah)') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh 'buildah login -u $DOCKER_USER -p $DOCKER_PASS docker.io'
        }
      }
    }

    stage('Build Images with Buildah') {
      steps {
        sh '''
          buildah bud -t docker.io/$REGISTRY/book-service:$BUILD_ID book-service
          buildah bud -t docker.io/$REGISTRY/user-service:$BUILD_ID user-service
        '''
      }
    }

    stage('SonarQube Scan') {
      steps {
        withCredentials([string(credentialsId: 'sonarqube-token', variable: 'SONAR_TOKEN')]) {
          sh '''
            echo "Running SonarQube analysis"

            buildah from --name sonar-cli docker.io/sonarsource/sonar-scanner-cli

            buildah unshare bash -c '
              mount_path=$(buildah mount sonar-cli)
              cp -r . $mount_path/usr/src

              cat <<EOF > $mount_path/usr/src/sonar-project.properties
sonar.projectKey=infrastructure-repo
sonar.sources=book-service,user-service
sonar.host.url=$SONAR_HOST_URL
sonar.login=$SONAR_TOKEN
EOF

              buildah run sonar-cli sonar-scanner -Dproject.settings=/usr/src/sonar-project.properties
            '

            buildah rm sonar-cli
          '''
        }
      }
    }

    stage('Push Images with Buildah') {
      steps {
        sh '''
          buildah push docker.io/$REGISTRY/book-service:$BUILD_ID
          buildah push docker.io/$REGISTRY/user-service:$BUILD_ID
        '''
      }
    }

    stage('Update Manifests & Push to Git') {
      environment {
        GIT_REPO_NAME = "Infrastructure_manifest_K8"
        GIT_USER_NAME = "khangesh9420"
      }
      steps {
        withCredentials([string(credentialsId: 'github', variable: 'GITHUB_TOKEN')]) {
          sh '''
            chmod +x update-images.sh
            ./update-images.sh

            git config --global user.name "$GIT_USER_NAME"
            git config --global user.email "khangeshmatte@gmail.com"

            CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            if [ "$CURRENT_BRANCH" = "HEAD" ] || [ -z "$CURRENT_BRANCH" ]; then
              CURRENT_BRANCH="main"
              git checkout $CURRENT_BRANCH
            fi

            git add k8s_manifest/book-deployment.yaml k8s_manifest/user-deployment.yaml

            if ! git diff --cached --quiet; then
              git commit -m "ci: update image tags to $BUILD_ID"
              git push https://${GITHUB_TOKEN}@github.com/${GIT_USER_NAME}/${GIT_REPO_NAME}.git $CURRENT_BRANCH
            else
              echo "No changes to commit"
            fi
          '''
        }
      }
    }
  }
}
