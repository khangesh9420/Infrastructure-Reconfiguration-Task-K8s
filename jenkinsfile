pipeline {
  agent { label 'k8s-agent' }
  environment {
    REGISTRY = "khangeshmatte123"
    BUILD_ID = "${env.BUILD_ID}"
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Login to Docker Hub (Buildah)') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh 'buildah login -u $DOCKER_USER -p $DOCKER_PASS docker.io'
        }
      }
    }

    stage('Build Images with Buildah') {
      steps {
        sh '''
          buildah bud -t docker.io/$REGISTRY/book-service:$BUILD_ID book-service
          buildah bud -t docker.io/$REGISTRY/user-service:$BUILD_ID user-service
        '''
      }
    }

    stage('Push Images with Buildah') {
      steps {
        sh '''
          buildah push docker.io/$REGISTRY/book-service:$BUILD_ID
          buildah push docker.io/$REGISTRY/user-service:$BUILD_ID
        '''
      }
    }
    
    stage('Update Manifests & Push to Git') {
      environment {
        COMMIT_BRANCH = "${env.BRANCH_NAME ?: 'main'}"
        }
      steps {
        sh '''
          chmod +x update-images.sh
          ./update-images.sh
           git config --global user.name "khangesh9420"
           git config --global user.email "khangeshmatte@gmail.com"
    
           # Get the current branch from Jenkins env or fallback
           CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
           if [ -z "$CURRENT_BRANCH" ] || [ "$CURRENT_BRANCH" = "HEAD" ]; then
             CURRENT_BRANCH="main"  # fallback branch name
           fi
    
           echo "On branch: $CURRENT_BRANCH"
    
           git add .
           git commit -m "ci: update image tags to $BUILD_ID"
           git push origin "$COMMIT_BRANCH"
        '''
      }
    }
  }
}
