pipeline {
  agent { label 'k8s-agent' }
  environment {
    REGISTRY = "khangeshmatte123"
    BUILD_ID = "${env.BUILD_ID}"
  }
  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Login to Docker Hub (Buildah)') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'docker-hub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
          sh 'buildah login -u $DOCKER_USER -p $DOCKER_PASS docker.io'
        }
      }
    }

    stage('Build Images with Buildah') {
      steps {
        sh '''
          buildah bud -t docker.io/$REGISTRY/book-service:$BUILD_ID book-service
          buildah bud -t docker.io/$REGISTRY/user-service:$BUILD_ID user-service
        '''
      }
    }

    stage('Push Images with Buildah') {
      steps {
        sh '''
          buildah push docker.io/$REGISTRY/book-service:$BUILD_ID
          buildah push docker.io/$REGISTRY/user-service:$BUILD_ID
        '''
      }
    }

    stage('Deploy to Kubernetes') {
      steps {
        sh '''
          kubectl set image deployment/book-service book-service=docker.io/$REGISTRY/book-service:$BUILD_ID
          kubectl set image deployment/user-service user-service=docker.io/$REGISTRY/user-service:$BUILD_ID
          kubectl apply -f k8s/book-service.yaml
          kubectl apply -f k8s/user-service.yaml
          kubectl apply -f k8s/ingress.yaml
        '''
      }
    }
  }
}
